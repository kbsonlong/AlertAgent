# AlertAgent 测试框架文档

## 概述

本文档描述了AlertAgent项目的完整测试框架，包括单元测试、集成测试、性能测试和自动化CI/CD流程。

## 测试架构

### 测试分层

```
┌─────────────────────────────────────────────────────────────┐
│                    E2E Tests                                │
├─────────────────────────────────────────────────────────────┤
│                Integration Tests                            │
├─────────────────────────────────────────────────────────────┤
│                  Unit Tests                                 │
├─────────────────────────────────────────────────────────────┤
│              Component Tests                                │
└─────────────────────────────────────────────────────────────┘
```

### 测试目录结构

```
tests/
├── integration/           # 集成测试
│   ├── setup_test.go     # 测试环境设置
│   ├── sidecar_sync_test.go  # Sidecar配置同步测试
│   ├── async_task_test.go    # 异步任务处理测试
│   ├── notification_plugin_test.go  # 通知插件测试
│   └── config_test.yaml  # 测试配置
├── performance/          # 性能测试
│   ├── setup_test.go     # 性能测试环境
│   ├── alert_processing_test.go  # 告警处理性能测试
│   └── resource_monitor.go      # 资源监控工具
└── mocks/               # 模拟服务
    └── dingtalk/        # 钉钉模拟服务
```

## 集成测试

### 11.1 集成测试开发

#### Sidecar配置同步集成测试

**测试范围:**
- 完整配置同步流程测试
- 配置变更检测测试
- 同步失败重试测试
- 多集群配置同步测试

**关键测试用例:**
```go
func TestSidecarConfigSync(t *testing.T) {
    t.Run("完整配置同步流程", func(t *testing.T) {
        testCompleteSyncFlow(t, server.URL)
    })
    
    t.Run("配置变更检测", func(t *testing.T) {
        testConfigChangeDetection(t, server.URL)
    })
    
    t.Run("同步失败重试", func(t *testing.T) {
        testSyncFailureRetry(t, server.URL)
    })
    
    t.Run("多集群配置同步", func(t *testing.T) {
        testMultiClusterSync(t, server.URL)
    })
}
```

#### 异步任务处理端到端测试

**测试范围:**
- AI分析任务处理测试
- 通知任务处理测试
- 配置同步任务处理测试
- 任务重试机制测试
- 并发任务处理测试
- 任务优先级处理测试

**关键特性:**
- 模拟真实的任务生产者和消费者
- 测试任务状态流转
- 验证任务处理结果
- 测试错误处理和重试逻辑

#### 通知插件集成测试

**测试范围:**
- 插件注册和发现测试
- 钉钉插件集成测试
- 邮件插件集成测试
- 企业微信插件集成测试
- 插件配置验证测试
- 插件健康检查测试
- 插件故障处理测试
- 多插件并发通知测试

**模拟服务:**
- 钉钉Webhook模拟服务
- SMTP邮件服务模拟
- 企业微信API模拟服务

## 性能测试

### 11.2 性能测试实施

#### 高并发告警处理性能测试

**测试场景:**
- 低并发基准测试 (10并发, 1000告警)
- 中等并发测试 (50并发, 5000告警)
- 高并发压力测试 (100并发, 10000告警)
- 极限并发测试 (200并发, 20000告警)

**性能指标:**
- TPS (每秒事务数)
- 平均延迟
- P95/P99延迟
- 错误率
- 内存使用
- CPU使用率

#### 配置同步性能基准测试

**测试场景:**
- 小规模集群同步 (10集群, 10KB配置)
- 中等规模集群同步 (50集群, 50KB配置)
- 大规模集群同步 (100集群, 100KB配置)

**性能指标:**
- 同步延迟
- 同步成功率
- 吞吐量
- 资源使用

#### 系统资源使用监控测试

**监控指标:**
- CPU使用率 (峰值/平均)
- 内存使用 (峰值/平均)
- Goroutine数量
- GC暂停时间
- 数据库连接池状态

**资源监控器特性:**
```go
type ResourceMonitor struct {
    cpuSamples    []float64
    memorySamples []int64
    gcPauses      []time.Duration
    mutex         sync.RWMutex
    running       bool
}
```

## 自动化测试流程

### 11.3 自动化测试流程

#### CI/CD流水线

**GitHub Actions工作流:**
```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨2点运行完整测试
```

**流水线阶段:**
1. **代码质量检查** - go vet, golangci-lint
2. **单元测试** - 覆盖率报告
3. **集成测试** - MySQL/Redis服务
4. **性能测试** - 基准测试和负载测试
5. **前端测试** - lint, 类型检查, 单元测试
6. **构建和打包** - 多平台二进制文件
7. **Docker构建** - 多架构镜像
8. **安全扫描** - Trivy, gosec
9. **部署** - 测试环境和生产环境

#### 测试自动化脚本

**主要脚本:**
- `scripts/test_automation.sh` - 统一测试执行脚本
- `scripts/quality_gate.sh` - 质量门禁检查
- `scripts/generate_perf_report.go` - 性能报告生成

**使用示例:**
```bash
# 运行所有测试
./scripts/test_automation.sh all -r

# 运行集成测试
./scripts/test_automation.sh integration -v

# 运行性能测试
./scripts/test_automation.sh performance -r

# 质量门禁检查
./scripts/quality_gate.sh
```

#### Docker测试环境

**测试服务配置:**
```yaml
services:
  mysql-test:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: alertagent_test
    ports:
      - "3306:3306"
    
  redis-test:
    image: redis:7.0-alpine
    ports:
      - "6379:6379"
    
  prometheus-mock:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
```

#### 质量门禁

**质量标准:**
- 代码覆盖率 ≥ 80%
- 圈复杂度 ≤ 10
- 错误率 ≤ 1%
- 性能评分 ≥ 80分

**检查项目:**
- 代码覆盖率检查
- 代码复杂度检查
- 代码质量检查 (go vet, golangci-lint)
- 安全检查 (gosec, nancy)
- 性能检查
- 技术债务检查
- 文档质量检查
- 依赖管理检查

## 测试工具和框架

### Go测试框架
- **testing** - Go标准测试框架
- **testify** - 断言和模拟框架
- **gorm** - 数据库ORM测试
- **redis** - Redis客户端测试

### 性能测试工具
- **基准测试** - Go内置benchmark
- **负载测试** - 自定义负载测试框架
- **资源监控** - 自定义资源监控器
- **性能分析** - pprof集成

### CI/CD工具
- **GitHub Actions** - 持续集成
- **Docker** - 容器化测试环境
- **Kubernetes** - 部署测试
- **Trivy** - 安全扫描

## 测试数据管理

### 测试数据库
- **测试数据库** - alertagent_test
- **性能测试数据库** - alertagent_perf_test
- **数据隔离** - 每个测试用例独立数据

### 模拟数据
- **告警数据** - 模拟各种告警场景
- **配置数据** - 模拟不同集群配置
- **通知数据** - 模拟通知渠道配置

### 数据清理
- **自动清理** - 测试完成后自动清理
- **隔离清理** - 不同测试间数据隔离
- **定期清理** - 定期清理过期测试数据

## 测试报告

### 覆盖率报告
- **HTML报告** - 可视化覆盖率报告
- **命令行报告** - 简洁的覆盖率统计
- **趋势分析** - 覆盖率变化趋势

### 性能报告
- **基准测试报告** - 详细的性能指标
- **负载测试报告** - 并发性能分析
- **资源使用报告** - 系统资源消耗
- **趋势分析** - 性能变化趋势

### 质量报告
- **代码质量** - lint和vet结果
- **安全报告** - 安全扫描结果
- **技术债务** - TODO和FIXME统计
- **依赖分析** - 依赖更新和漏洞

## 最佳实践

### 测试编写
1. **测试命名** - 清晰描述测试目的
2. **测试隔离** - 每个测试独立运行
3. **数据准备** - 使用setup和teardown
4. **断言明确** - 使用有意义的断言消息
5. **错误处理** - 测试错误场景

### 性能测试
1. **基准建立** - 建立性能基准线
2. **环境一致** - 保持测试环境一致性
3. **多次运行** - 多次运行取平均值
4. **资源监控** - 监控系统资源使用
5. **回归检测** - 检测性能回归

### CI/CD集成
1. **快速反馈** - 快速失败原则
2. **并行执行** - 并行运行测试
3. **环境管理** - 自动化环境管理
4. **结果通知** - 及时通知测试结果
5. **质量门禁** - 严格的质量标准

## 故障排查

### 常见问题
1. **测试环境问题** - 数据库连接失败
2. **并发问题** - 竞态条件
3. **资源不足** - 内存或CPU不足
4. **网络问题** - 服务连接超时
5. **数据污染** - 测试数据相互影响

### 调试技巧
1. **日志分析** - 查看详细日志
2. **断点调试** - 使用delve调试器
3. **性能分析** - 使用pprof分析
4. **资源监控** - 监控系统资源
5. **隔离测试** - 单独运行失败测试

## 总结

AlertAgent的测试框架提供了完整的测试解决方案，包括：

1. **全面的测试覆盖** - 从单元测试到端到端测试
2. **自动化的CI/CD流程** - 完全自动化的测试和部署
3. **严格的质量门禁** - 确保代码质量和性能标准
4. **详细的测试报告** - 提供全面的测试和性能分析
5. **高效的开发体验** - 简化的测试执行和调试流程

这个测试框架确保了AlertAgent系统的高质量、高性能和高可靠性，为持续集成和持续部署提供了坚实的基础。